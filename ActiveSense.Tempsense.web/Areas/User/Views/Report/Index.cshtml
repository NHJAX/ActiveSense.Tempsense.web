@model IEnumerable<ActiveSense.Tempsense.model.Model.Measure>
@{
    ViewBag.Title = "Reportes";
}
<div style="padding: 0%; background-color: #babdc7;" class="panel panel">
    <div class="panel-heading"><h2>Reporte</h2></div>
    <div class="panel-body">
        <div id="listaMeasures" class="form-inline">
            <div class="row">
                <div class="col-xs-5 col-md-5">
                    <div class="form-group">

                        <div id="dateStart" class="input-append">
                            <label for="dateStart"> date Inicio </label>
                            <input class="form-control" data-format="yyyy-MM-dd" type="text" id="dateStartData" />
                            <span class="add-on">
                                <i data-time-icon="icon-time" data-date-icon="icon-calendar">
                                    <img src="~/Content/images/img_calendar.png" />
                                </i>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-xs-5 col-md-5">
                    <div class="form-group">

                        <div id="dateEnd" class="input-append">
                            <label for="dateEnd"> date Fin </label>
                            <input data-format="yyyy-MM-dd" type="text" class="form-control" id="dateEndData" />
                            <span class="add-on">
                                <i data-time-icon="icon-time" data-date-icon="icon-calendar">
                                    <img src="~/Content/images/img_calendar.png" />
                                </i>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-xs-2 col-md-2">
                    <div class="form-group">
                        <div>
                            <button type="button" id="btnPrint" class="btn btn-primary">Imprimir</button>
                        </div>
                    </div>
                </div>
            </div>
            <br />
            <div class="row">
                <div class="col-xs-5 col-md-5">
                    <label for="DeviceID"> Empresa</label>
                    <div class="form-group">
                        @Html.DropDownList("Companies", null, htmlAttributes: new { @class = "form-control" })
                    </div>
                    <div class="clearfix"></div>
                </div>
                <div class="col-xs-5 col-md-5" id="contentSelectDisp">
                    <label for="DeviceID"> Sensor</label>
                    <div class="form-group">
                        @Html.DropDownList("DeviceID", null, htmlAttributes: new { @class = "form-control" })
                        <img id="prelaodInner" src="~/Content/images/preloadInner.gif" />
                    </div>
                    <div class="clearfix"></div>
                </div>
                <div class="col-xs-3 col-md-3">
                    <label for="FilterTime"> Filter </label><br />
                    <div class="form-group">
                        @Html.DropDownList("FilterTime", null, htmlAttributes: new { @class = "form-control" })
                    </div>
                    <div class="clearfix"></div>
                </div>
            </div>
        </div>
    </div>
</div>



<br />

<div id="ContenedorPreload">
    <img src="~/Content/images/8.gif" />
</div>

<div id="printThis">
    <h3 id="title_graphic"></h3>
    <canvas id="graphicalMeasures" width="200" height="100"></canvas>
</div>
<br />
<div id="printThis2">
    <div id="Paginatedtable" class="table-responsive">
        <table id="TableMeasures" class="display" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Value</th>
                    <th>device</th>
                    <th>date time</th>
                </tr>
            </thead>
        </table>
    </div>
</div>
@section scripts{

    <script type="text/javascript">

        var objTablePaged  = '';
        var MESSAGE_ERROR_date_MORE  = 'Date initial must be less that the end date';
        var MESSAGE_ERROR_date_EMPTY = 'You must enter the two dates';
        var MESSAGE_ERROR_CONNECTION = "Has been an error in the system please try again";
        var MESSAGE_ERROR_DEVICE = "Please select a device";
        var FILTER_DAYS = 1440;
        var MESSAGE_ERROR_DATE_FILTER = 'You must enter the two dates for this filter ';

        $(document).ready(function () {

            $('#TableMeasures').hide();
            $("#ContainerPreload").hide();

            $('#dateStart').datetimepicker({
                pickTime: false,
                autoclose: true
            });

            $('#dateEnd').datetimepicker({
                pickTime: false,
                autoclose: true
            });

            // funcion que permite limpiar los calendarios si ha ocurrido un error
            function CleanCalendar() {
                $("#dateStartData").val('');
                $("#dateEndData").val('');
            }

            // evento de cambio de device
            $("#DeviceID").change(function () {
                ToFindInformation();
            });

            //evento de cambio de filter tiempo
            $('#FilterTime').change(function () {
                var Valuefilter = $(this).val();
                if (Valuefilter != 0 && Valuefilter != "") {
                    ToFindInformation();
                }
            });

            //evento de cambio de empresa
            $('#Companies').change(function () {
                var idCompany = $(this).val();
                if (idCompany != 0 && idCompany != "") {

                    $("#DeviceID").html("");
                    $("#DeviceID").hide();
                    $('#prelaodInner').show();
                    $.ajax({
                        url: '@Url.Action("ObtenerdeviceAsociado", "Report" )',
                        type: 'POST',
                        data: JSON.stringify({ idCompany: idCompany }),
                        datatype: 'application/json',
                        contentType: 'application/json',
                        cache: false,
                        success: function (result) {
                            $.each($.parseJSON(result), function (i, device) {
                                $("#DeviceID").append($('<option></option>').val(device.idDevice).html(device.NameDevice))
                            })
                            $('#prelaodInner').hide();
                            $("#DeviceID").show();
                            ToFindInformation();

                        },
                        error: function (xhr, error) {
                            $('#prelaodInner').hide();
                            $("#DeviceID").show();
                            Command: toastr["error"](MESSAGE_ERROR_CONNECTION, 'ERROR');
                        },
                    });
                }
            });

            //funcion que permite realizar la busqueda cuando se cambia o seleciona el device
            function ToFindInformation() {
                var idDevice = $("#DeviceID").val();
                var dateStart = $("#dateStartData").val();
                var dateEnd = $("#dateEndData").val();

                if (ValidateRequest(dateStart, dateEnd)) {
                    $('#TableMeasures').show();
                    RenderTable(idDevice, dateStart, dateEnd);
                    SolicitorDataStatistics();
                }
            }

            // funcion de proposito general que permite validar una peticion
            function ValidateRequest(dateStart, dateEnd) {
                var validacionD = validateDevice();;
                var validacionF = validateDates(dateStart, dateEnd);
                var validacionFtr = ValidateFilterDays(dateStart, dateEnd);
                return (validacionD && validacionF && validacionFtr) ? true : false;
            }

            // funcion que permite validar si se han seleccionado los dias para
            // para realizar el filter por dias
            function ValidateFilterDays(dateStart, dateEnd) {
                var IsValid = true;
                var filter = $("#FilterTime").val();
                if ( filter == FILTER_DAYS ) {
                    if (dateStart == "" || dateEnd == "") {
                        Command: toastr["error"](MESSAGE_ERROR_DATE_FILTER, 'ERROR');
                        IsValid = false;
                    }
                }
                return IsValid;
            }

            // funcion de validacion de device
            function validateDevice() {
                var idDevice = $("#DeviceID").val();
                var validate = false;
                if (idDevice != 0 && idDevice != undefined) {
                    validate = true;
                } else {
                    Command: toastr["error"](MESSAGE_ERROR_DEVICE, 'ERROR');
                }
                return validate;
            }

            // funcion que permite validar que la date de inicio se mayor que la date final
            function validateDates(dateStart, dateEnd) {
                if (dateStart > dateEnd) {
                    Command: toastr["error"](MESSAGE_ERROR_date_MORE , 'ERROR');
                    CleanCalendar();
                    return false;
                }

                if (dateStart == "" && dateEnd != "") {
                    Command: toastr["error"](MESSAGE_ERROR_date_EMPTY, 'ERROR');
                    CleanCalendar();
                    return false;
                }
                return true;
            }

            //funcion encargada construir la tabla de Measures recibe como parametro
            //identificacion de device, date de inicio, date de fin
            // ademas permite Register eventos cuando se presiona el selector de tamaño y se pagina
            function RenderTable(idDevice, dateStart, dateEnd) {

                //Mostrar contenedor de tabla
                var objTableMeasuresVisual = $('#TableMeasures');
                objTableMeasuresVisual.show();
                //Obtener tabla
                var ObjContainerPaginatedTable = $('#Paginatedtable');
                //Generar tabla
                objTablePaged  = objTableMeasuresVisual.DataTable({
                    "processing": true,
                    "serverSide": true,
                    "searching": false,
                    "destroy": true,
                    "lengthMenu": [10, 15, 20],
                    language: {
                        processing: "Procesando...",
                        search: "ToFind:",
                        lengthMenu: "Mostrar _MENU_ registros",
                        info: "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                        infoEmpty: "Mostrando registros del 0 al 0 de un total de 0 registros",
                        infoFiltered: "(filtrado de un total de _MAX_ registros)",
                        infoPostFix: "",
                        loadingRecords: "Cargando...",
                        zeroRecords: "No se encontraron resultados",
                        emptyTable: "Ningún dato disponible en esta tabla",
                        paginate: {
                            first: "Primero",
                            previous: "Ant",
                            next: "Sig",
                            last: "Último",
                        },
                        aria: {
                            sortAscending: ": Activar para ordenar la columna de manera ascendente",
                            sortDescending: ": Activar para ordenar la columna de manera descendente"
                        }
                    },
                    //Peticion de datos servicio
                    "ajax": {
                        "type": "POST",
                        "url": '@Url.Action("ObtenerDatosTabla", "Report" )',
                        //"data": {
                        //    "idDevice": idDevice,
                        //    "dateStart": dateStart,
                        //    "dateEnd": dateEnd
                        //},
                        "data": function (d) {
                            d.idDevice = idDevice,
                            d.dateStart = $("#dateStartData").val(),
                            d.dateEnd = $("#dateEndData").val(),
                            d.FilterTime = $("#FilterTime").val()
                        },
                        // Mostras toastr error si hay error
                        "error": function () {
                            ObjContainerPaginatedTable.hide();
                            Command: toastr["error"](MESSAGE_ERROR_CONNECTION, 'ERROR');
                        }
                    },
                    "columns": [
                        { "data": "temperature", "orderable": false },
                        { "data": "NameDevice", "orderable": false },
                        { "data": "date", "orderable": false }
                    ]
                });

                var objdateStart = $("#dateStartData");
                var objdateEndal = $("#dateEndData");

                objTablePaged .on('length.dt', function (e, settings, len) {
                    var dateStart = objdateStart.val();
                    var dateEnd = objdateEndal.val();
                    if (ValidateRequest(dateStart, dateEnd)) {
                        SolicitorDataStatistics();
                    }
                });

                objTablePaged .on('page.dt', function () {
                    var dateStart = objdateStart.val();
                    var dateEnd = objdateEndal.val()


                    if (ValidateRequest(dateStart, dateEnd)) {
                        SolicitorDataStatistics();
                    }
                });

            }


            // funcion que permite construir la tabla estadistico recibe como parametro
            // un arreglo de dates y un arreglo de temperatures.
            function renderizarGraficaEstadistica(dates, temperatures, UpperThreshold , LowerThreshold , LowerToleranceList, UpperToleranceList) {
                var canvas = document.getElementById("graphicalMeasures");
                var ctx = canvas.getContext("2d");


                var horizonalLinePlugin = {
                    afterDraw: function (chartInstance) {
                        var yScale = chartInstance.scales["y-axis-0"];
                        var canvas = chartInstance.chart;
                        var ctx = canvas.ctx;
                        var index;
                        var line;
                        var style;

                        if (chartInstance.options.horizontalLine) {
                            for (index = 0; index < chartInstance.options.horizontalLine.length; index++) {
                                line = chartInstance.options.horizontalLine[index];

                                if (!line.style) {
                                    style = "rgba(169,169,169, .6)";
                                } else {
                                    style = line.style;
                                }

                                if (line.y) {
                                    yValue = yScale.getPixelForValue(line.y);
                                } else {
                                    yValue = 0;
                                }

                                ctx.lineWidth = 3;

                                if (yValue) {
                                    ctx.beginPath();
                                    ctx.moveTo(0, yValue);
                                    ctx.lineTo(canvas.width, yValue);
                                    ctx.strokeStyle = style;
                                    ctx.stroke();
                                }

                                if (line.text) {
                                    ctx.fillStyle = style;
                                    ctx.fillText(line.text, 0, yValue + ctx.lineWidth);
                                }
                            }
                            return;
                        };
                    }
                };
                Chart.pluginService.register(horizonalLinePlugin);

                var data = {
                    labels: dates,
                    datasets: [
                                {
                                    label: "Value",
                                    borderColor: "rgba(75,192,192,1)",
                                    data: temperatures,
                                    spanGaps: true,
                                },
                                {
                                    label: "Tolerance Maximum",
                                    lineTension: 0.1,
                                    borderColor: "#ff0000",
                                    borderDashOffset: 0.0,
                                    pointBorderWidth: 0,
                                    pointHoverRadius: 0,
                                    pointHoverBorderWidth: 0,
                                    pointRadius: 0,
                                    pointHitRadius: 0,
                                    backgroundColor: "rgba(0,0,0,0)",
                                    data: UpperToleranceList,
                                },
                                {

                                    label: "Tolerance Minimum",
                                    fill: false,
                                    lineTension: 0.1,
                                    borderColor: "#ff0000",
                                    borderDashOffset: 0.0,
                                    pointBorderWidth: 0,
                                    pointHoverRadius: 0,
                                    pointHoverBorderWidth: 0,
                                    pointRadius: 0,
                                    pointHitRadius: 0,
                                    backgroundColor: "rgba(0,0,0,0)",
                                    data: LowerToleranceList,
                                },
                                 {
                                     label: "temperature Maximum",
                                     lineTension: 0.1,
                                     borderColor: "#000000",
                                     borderDashOffset: 0.0,
                                     pointBorderWidth: 0,
                                     pointHoverRadius: 0,
                                     pointHoverBorderWidth: 0,
                                     pointRadius: 0,
                                     pointHitRadius: 0,
                                     backgroundColor: "rgba(0,0,0,0)",
                                     data: UpperThreshold ,
                                 },
                                   {
                                       label: "temperature Minimum",
                                       lineTension: 0.1,
                                       borderColor: "#000000",
                                       borderDashOffset: 0.0,
                                       pointBorderWidth: 0,
                                       pointHoverRadius: 0,
                                       pointHoverBorderWidth: 0,
                                       pointRadius: 0,
                                       pointHitRadius: 0,
                                       backgroundColor: "rgba(0,0,0,0)",
                                       data: LowerThreshold ,
                                   }

                    ]
                };

                var tolMaximum = UpperToleranceList[0] !== undefined ? UpperToleranceList[0] : 0;
                var tolMinimum = LowerToleranceList[0] !== undefined ? LowerToleranceList[0] : 0;

                var myChart = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        "horizontalLine":
                            [
                                {
                                    "y": tolMaximum,
                                    "style": "#ff0000",
                                    "text": "Tol Max : " + tolMaximum
                                },
                                {
                                    "y": tolMinimum,
                                    "style": "#ff0000",
                                    "text": "Tol Min : " + tolMinimum
                                },
                            ],
                        scales: {
                            xAxes: [{
                                display: true,
                                scaleLabel: {
                                    display: true,
                                    labelString: 'dates'
                                }
                            }],
                            yAxes: [{
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Value'
                                }
                            }]
                        },
                        responsive: true,
                    }
                });

            }

            // funcion que permite cargar los datos mediante peticiones ajax para mostrar en grafica
            // luego llama a funcion para renderizar la grafica estadistica
            function SolicitorDataStatistics() {
                var info = objTablePaged .page.info();
                $("#graphicalMeasures").hide();
                var ObjTitleGraphic = $("#title_graphic");
                ObjTitleGraphic.text('');
                $("#ContainerPreload").show();

                $.ajax(
               {
                   url: '@Url.Action("DataChart", "Report")',
                   data: {
                       pageIndex: 1,
                       start: info.start,
                       length: info.length,
                       idDevice: $("#DeviceID").val(),
                       dateStart: $("#dateStartData").val(),
                       dateEnd: $("#dateEndData").val(),
                       FilterTime: $("#FilterTime").val(),
                   },
                   type: "POST",
                   success: function (msg) {
                       $("#ContainerPreload").hide();

                       if (msg.dates.length > 0) {
                           $("#graphicalMeasures").show();
                           renderizarGraficaEstadistica(msg.dates, msg.temperatures,
                                                   msg.Thresholduperior, msg.ThresholdInferior,
                                                   msg.LowerToleranceList, msg.UpperToleranceList);
                           ObjTitleGraphic.text("Gráfica " + $("#DeviceID option:selected").text());
                       }


                   },
                   error: function (result) {
                       ObjTitleGraphic.html('');
                       $("#ContainerPreload").hide();
                   }
               });
            }
        });

        //var canvas = document.getElementById('graphicalMeasures');
        //printBtn.addEventListener('click', function () {
        //    document.body.removeChild(canvas);
        //    var img = new Image;
        //    img.id = 'tempPrintImage';
        //    img.onload = print;
        //    img.src = canvas.toDataURL();
        //    document.body.appendChild(img);
        //}, false);

        document.getElementById("btnPrint").onclick = function () {
            printElement(document.getElementById("printThis"));
            printElement(document.getElementById("printThis2"), true, "<hr />");
            window.print();
        }

        function printElement(elem, append, delimiter) {
            var domClone = elem.cloneNode(true);

            var $printSection = document.getElementById("printSection");

            if (!$printSection) {
                var $printSection = document.createElement("div");
                $printSection.id = "printSection";
                document.body.appendChild($printSection);
            }

            if (append !== true) {
                $printSection.innerHTML = "";
            }

            else if (append === true) {
                if (typeof (delimiter) === "string") {
                    $printSection.innerHTML += delimiter;
                }
                else if (typeof (delimiter) === "object") {
                    $printSection.appendChlid(delimiter);
                }
            }

            $printSection.appendChild(domClone);
        }

    </script>
    <script src="~/Scripts/Chart.bundle.min.js" type="text/javascript"></script>
}


